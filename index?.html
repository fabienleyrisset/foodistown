<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>


<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="jquery.fittext.js"></script>
<script>
  jQuery("#responsive_headline").fitText();
  //V1.2.3
</script>


  <title>FoodisTown</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />

  <style type="text/css">
html { height: 100% }
body { height: 100%; margin: 0; padding: 0 }
  </style>
  <link rel="stylesheet" type="text/css" href="style_divnouv122.css" />

  <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAhFjS5juAqfjo5vk6cO-zJJmkYQNDrlnQ&amp;sensor=false&amp;region=fr">
//src="https://maps.googleapis.com/maps/api/place/radarsearch/json?name=rosa bonheur&AIzaSyAhFjS5juAqfjo5vk6cO-zJJmkYQNDrlnQ&sensor=false&region=fr">
  </script>
  <script type="text/javascript" src="ajax3.js"></script>
  <script type="text/javascript" src="jquery.js"></script>
  <script src="http://code.jquery.com/jquery-latest.js"></script>
  <script type="text/javascript" src="xml2json.js"></script>
  <script type="text/javascript" src="admin.js"></script>
  <script type="text/javascript">
var response;
var crotte = new Array;
var lc_div; //div pour affichage liste lieux ds contenu gauche
var geocoder;
var p_suite;
var direction;
var myPoints = [];
var p_suite_old=null;
var p_suite_id;
var p_suite_old_id;
var lieu_recup;
var n_distance=0;
var nbre_lieux=0;
var latitude;
var longitude;
var map;
var pos;
var action;
var Distance;
var distance;
var Monadresse; //lieu de départ
var Monadresse_O;//leiu class
var oParams;
var lieu; //objet lieu
var aParams;
var reqParams;
// var xhr = getXMLHttpRequest();
var res;
var monurl;
var codepostal;
var latreq;
var longreq;
var nomreq;
var Lat;
var maxdist;
var Lng;
var tabreq = new Array;
var tabreq_ssdbl = new Array;
var tabreq_numresto = new Array;
//var tab = new Array;
var nb_reponses;//nbre de reponses à la requete
//var tabreq = new Array;
var l_div;
var vehicule;
var travelmode;
var chaine_mode_transport;
var num_page;
var nb_pages;
var prev_infowindow="0";
var infowindow;
var markers = [];
var i_deb;
var i_fin;
//var oReq;

function MonLieu(nom,adresse,idbase,cp,lat,lng,action,budget,phone,genre,distance,award,lien,numresto,guide,award1,award2,award3)
{
		{ 
		this.nom = nom;
		this.adresse = adresse;
		this.idbase = idbase;
		this.cp = cp;
		this.lat = lat;
		this.lng = lng;
		this.action = action;
		this.budget = budget; 
		this.phone = phone;
		this.genre = genre;
		this.distance = distance;
		this.award = award;
		this.lien = lien;
		this.numresto = numresto;
		this.guide = guide;
		this.awardfood = "";
		this.awardmich = "";
		this.awardgem = "";
		this.awardomn = "";
		//this.awardgem = "";
		this.lienfood = "";
		this.lienmich = "";
		this.liengem = "";
		this.lienomn = "";
		
		//this.attribut2 = parametre2; this.ajout_distance = function(distance) { //alert("classe ajout distance" + distance);
		this.distance = distance;
		}
		this.ajout_coord = function(lat,lng) 
		{ //alert("classe ajout coord" + lat + lng);
		this.lat = lat;
		this.lng = lng;
		} 
		
		this.change_nom = function(nom) 
		{ //alert("classe ajout coord" + lat + lng);
		this.nom = nom;
		} 
		
		this.ajout_distance = function(distance) { 

        //alert("classe ajout distance" + distance);
		this.distance = distance;
		}
} 



function initialize_map() {

var rendererOptions = {
  map: map,
  suppressMarkers : true
}
   direction = new google.maps.DirectionsRenderer(rendererOptions);
  var chicago = new google.maps.LatLng(48.85296820,2.34990210);
  var mapOptions = {
    zoom:12,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    center: chicago
  }
  
  
    map = new google.maps.Map(document.getElementById("Plan"), mapOptions);
    direction.setMap(map);
  }

  function initialize_old() {
    geocoder = new google.maps.Geocoder();
    //centre de Paris
    var latlng = new google.maps.LatLng(48.85296820,2.34990210);
    var mapOptions = {
      zoom: 14,
      center: latlng,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    }
    map = new google.maps.Map(document.getElementById("Plan"), mapOptions);
	var maison = new google.maps.Marker
	({
		map: map,
		position: new google.maps.LatLng(48.8845705, 2.3801582)
	});
  }

function re_initGM(){
    geocoder = new google.maps.Geocoder();
    var mapOptions = {
      center: mylatlng,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    }
    //centre de Paris
    //on récupère la distance la plu sgrance pour caler le zoom
    var mylatlng = new google.maps.LatLng(Monadresse.lat,Monadresse.lng);
    var mysuite = new google.maps.LatLng(tabreq[nb_reponses-1].lat,tabreq[nb_reponses-1].lng);
	map = new google.maps.Map(document.getElementById("Plan"), mapOptions)
	var circleOptions = {
    	center: mylatlng,
    	fillOpacity: 0,
    	strokeOpacity:0,
    	map: map,
    	radius: maxdist 
		}
		
	var myPoints = [];
   myPoints.push( new google.maps.LatLng(tabreq[nb_reponses-1].lat,tabreq[nb_reponses-1].lng)); // Paris
   //myPoints.push( new google.maps.LatLng(48.8123155, 2.2381535)); // Meudon	
	var bounds = new google.maps.LatLngBounds();
	bounds.extend(mylatlng);
	bounds.extend(myPoints[0]);
	
	
	//var myCircle = new google.maps.Circle(circleOptions);
		//alert(nb_reponses);
	map.fitBounds(bounds);


  }

//envoi une requete
function Initialise_Affichage_liste(lieu)
{
//alert("aff=iche liste verif moi" + Monadresse.nom);
lc_div = document.getElementById("contenu_gauche");
//if (lc_div.innerHTML == ""){
var D_itineraire = Calcul_distance(Monadresse,lieu);
//lc_div.innerHTML += "<UL>" + lieu.nom + "<li>" + lieu.adresse + "</li>" + "</UL>";
// créer un lien vers une page qui affiche
}





function delete_double(nb_reponses)
{
	var i=0;
	j=0;
	//alert(nb_reponses);
	tabreq_ssdbl= [];
	tabreq.sort(function(a, b) { return a.numresto - b.numresto;});
	while (i<nb_reponses-3)
	{
		tabreq_numresto = [];
		//alert("delete" +i );
		
		if((tabreq[i].numresto==tabreq[i+1].numresto)&&(tabreq[i].numresto==tabreq[i+2].numresto)&&(tabreq[i].numresto==tabreq[i+3].numresto))
		{//quaatron
			
			tabreq_numresto[0]=tabreq[i];
			tabreq_numresto[1]=tabreq[i+1];
			tabreq_numresto[2]=tabreq[i+2];
			tabreq_numresto[3]=tabreq[i+3];
			tabreq_numresto.sort(function(a, b) { return a.guide - b.guide;});
			//alert(tabreq_numresto[0].guide);
			//on remplit le Fooding
			tabreq_ssdbl[j]=tabreq_numresto[0];
			
			
			tabreq_ssdbl[j].awardfood=tabreq_numresto[0].award;
			tabreq_ssdbl[j].awardmich=tabreq_numresto[1].award;
			tabreq_ssdbl[j].awardgem=tabreq_numresto[2].award;
			tabreq_ssdbl[j].awardomn=tabreq_numresto[3].award;
			
			tabreq_ssdbl[j].lienfood=tabreq_numresto[0].lien;
  			tabreq_ssdbl[j].lienmich=tabreq_numresto[1].lien;
  			tabreq_ssdbl[j].liengem=tabreq_numresto[2].lien;
  			tabreq_ssdbl[j].liengomn=tabreq_numresto[3].lien;
			
			
			
			//tabreq_ssdbl[j].award = tabreq_numresto[0].award + "|" + tabreq_numresto[1].award + "|" + tabreq_numresto[2].award; 
			
			
			
			//tabreq_ssdbl[j].lien = tabreq_numresto[0].lien + "|" + tabreq_numresto[1].lien + "|" + tabreq_numresto[2].lien;
			
			i=i+4;
			j++;
		}
		
		
		else if((tabreq[i].numresto==tabreq[i+1].numresto)&&(tabreq[i].numresto==tabreq[i+2].numresto))
		{//triplon
			
			tabreq_numresto[0]=tabreq[i];
			tabreq_numresto[1]=tabreq[i+1];
			tabreq_numresto[2]=tabreq[i+2];
			tabreq_numresto.sort(function(a, b) { return a.guide - b.guide;});
			//alert(tabreq_numresto[0].guide);
			//on remplit le Fooding
			tabreq_ssdbl[j]=tabreq_numresto[0];
			tabreq_ssdbl[j].awardfood="";
			tabreq_ssdbl[j].awardmich="";
			tabreq_ssdbl[j].awardgem="";
			tabreq_ssdbl[j].awardomn="";
			tabreq_ssdbl[j].lienfood="";
			tabreq_ssdbl[j].lienmich="";
			tabreq_ssdbl[j].liengem="";
			tabreq_ssdbl[j].liengomn="";
			
			switch(tabreq_numresto[0].guide)
			{
			case "1"://fooding
  			tabreq_ssdbl[j].awardfood=tabreq_numresto[0].award;
  			tabreq_ssdbl[j].lienfood=tabreq_numresto[0].lien;
  			
  			break;
			case "2": //michelin
  			tabreq_ssdbl[j].awardmich=tabreq_numresto[0].award;
  			tabreq_ssdbl[j].lienmich=tabreq_numresto[0].lien;
  			
  			break;
			case "4"://omnivor
  			tabreq_ssdbl[j].awardomn=tabreq_numresto[0].award;
  			tabreq_ssdbl[j].lienomn=tabreq_numresto[0].lien;
  			
  			case "8": //getm
  			tabreq_ssdbl[j].awardgem=tabreq_numresto[0].award;
  			tabreq_ssdbl[j].liengem=tabreq_numresto[0].lien;
  			break;
			}

			switch(tabreq_numresto[1].guide)
			{
			case "1":
  			tabreq_ssdbl[j].awardfood=tabreq_numresto[1].award;
  			tabreq_ssdbl[j].lienfood=tabreq_numresto[1].lien;
  			break;
			case "2":
  			tabreq_ssdbl[j].awardmich=tabreq_numresto[1].award;
  			tabreq_ssdbl[j].lienmich=tabreq_numresto[1].lien;
  			break;
			case "4":
  			tabreq_ssdbl[j].awardomn=tabreq_numresto[1].award;
  			tabreq_ssdbl[j].liengomn=tabreq_numresto[1].lien;
  			break;
  			case "8":
  			tabreq_ssdbl[j].awardgem=tabreq_numresto[1].award;
  			tabreq_ssdbl[j].liengem=tabreq_numresto[1].lien;
  			break;
			}
			
			switch(tabreq_numresto[2].guide)
			{
			case "1":
  			tabreq_ssdbl[j].awardfood=tabreq_numresto[2].award;
  			tabreq_ssdbl[j].lienfood=tabreq_numresto[2].lien;
  			break;
			case "2":
  			tabreq_ssdbl[j].awardmich=tabreq_numresto[2].award;
  			tabreq_ssdbl[j].lienmich=tabreq_numresto[2].lien;
  			break;
			case "4":
  			tabreq_ssdbl[j].awardomn=tabreq_numresto[2].award;
  			tabreq_ssdbl[j].liengomn=tabreq_numresto[2].lien;
  			break;
  			case "8":
  			tabreq_ssdbl[j].awardgem=tabreq_numresto[2].award;
  			tabreq_ssdbl[j].liengem=tabreq_numresto[2].lien;
  			break;
			}
			
			
			//tabreq_ssdbl[j].award = tabreq_numresto[0].award + "|" + tabreq_numresto[1].award + "|" + tabreq_numresto[2].award; 
			
			
			
			//tabreq_ssdbl[j].lien = tabreq_numresto[0].lien + "|" + tabreq_numresto[1].lien + "|" + tabreq_numresto[2].lien;
			
			i=i+3;
			j++;
		}
		else if((tabreq[i].numresto==tabreq[i+1].numresto)&&(tabreq[i].numresto!=tabreq[i+2].numresto))
		{//doublon
			tabreq_numresto[0]=tabreq[i];
			tabreq_numresto[1]=tabreq[i+1];
			tabreq_numresto.sort(function(a, b) { return a.guide - b.guide;});
			
			tabreq_ssdbl[j]=tabreq_numresto[0];
		tabreq_ssdbl[j].awardfood="";
		tabreq_ssdbl[j].awardmich="";
		tabreq_ssdbl[j].awardgem="";
		tabreq_ssdbl[j].lienfood="";
		tabreq_ssdbl[j].lienmich="";
		tabreq_ssdbl[j].liengem="";
			
			switch(tabreq_numresto[0].guide)
			{
			case "1"://fooding
  			tabreq_ssdbl[j].awardfood=tabreq_numresto[0].award;
  			tabreq_ssdbl[j].lienfood=tabreq_numresto[0].lien;
  			
  			break;
			case "2": //michelin
  			tabreq_ssdbl[j].awardmich=tabreq_numresto[0].award;
  			tabreq_ssdbl[j].lienmich=tabreq_numresto[0].lien;
  			
  			break;
			case "4"://omnivor
  			tabreq_ssdbl[j].awardomn=tabreq_numresto[0].award;
  			tabreq_ssdbl[j].lienomn=tabreq_numresto[0].lien;
  			
  			case "8": //getm
  			tabreq_ssdbl[j].awardgem=tabreq_numresto[0].award;
  			tabreq_ssdbl[j].liengem=tabreq_numresto[0].lien;
  			break;
			}

			switch(tabreq_numresto[1].guide)
			{
			case "1":
  			tabreq_ssdbl[j].awardfood=tabreq_numresto[1].award;
  			tabreq_ssdbl[j].lienfood=tabreq_numresto[1].lien;
  			break;
			case "2":
  			tabreq_ssdbl[j].awardmich=tabreq_numresto[1].award;
  			tabreq_ssdbl[j].lienmich=tabreq_numresto[1].lien;
  			break;
			case "4":
  			tabreq_ssdbl[j].awardomn=tabreq_numresto[1].award;
  			tabreq_ssdbl[j].liengomn=tabreq_numresto[1].lien;
  			break;
  			case "8":
  			tabreq_ssdbl[j].awardgem=tabreq_numresto[1].award;
  			tabreq_ssdbl[j].liengem=tabreq_numresto[1].lien;
  			break;
			}

			//tabreq_ssdbl[j].award = tabreq_numresto[0].award + "|" + tabreq_numresto[1].award;
			//tabreq_ssdbl[j].lien = tabreq_numresto[0].lien + "|" + tabreq_numresto[1].lien ;
			
			i=i+2;
			j++;
			
		}
		else
		{//simplon
			tabreq_ssdbl[j]=tabreq[i];
		tabreq_ssdbl[j].awardfood="";
		tabreq_ssdbl[j].awardmich="";
		tabreq_ssdbl[j].awardgem="";
			switch(tabreq[i].guide)
			{
			case "1":
  			tabreq_ssdbl[j].awardfood=tabreq[i].award;
  			tabreq_ssdbl[j].lienfood=tabreq[i].lien;
  			break;
			case "2":
  			tabreq_ssdbl[j].awardmich=tabreq[i].award;
  			tabreq_ssdbl[j].lienmich=tabreq[i].lien;
  			break;
			case "4"://omnivor
  			tabreq_ssdbl[j].awardomn=tabreq[i].award;
  			tabreq_ssdbl[j].lienomn=tabreq[i].lien;
  			
  			case "8": //getm
  			tabreq_ssdbl[j].awardgem=tabreq[i].award;
  			tabreq_ssdbl[j].liengem=tabreq[i].lien;
  			break;
			}
			
			i++;
			j++;	
		}
		
	}
	tabreq_numresto = [];
//puis in teste les 3 derniers
	if(tabreq[nb_reponses-2].numresto==tabreq[nb_reponses-1].numresto)
	{//les 2 derniers sont des doublons
			tabreq_numresto[0]=tabreq[nb_reponses-2];
			tabreq_numresto[1]=tabreq[nb_reponses-1];
			tabreq_numresto.sort(function(a, b) { return a.guide - b.guide;});
			tabreq_ssdbl[j]=tabreq[nb_reponses-2];
			tabreq_ssdbl[j].award = tabreq[nb_reponses-2].award + "|" + tabreq[nb_reponses-1].award;
			
	}


}


function trie_affiche_tableau(param){
nb_reponses = tabreq.length;

delete_double(nb_reponses);

//trie un tableau tab d'objet selon la valeur de sa propriété distance
tabreq_ssdbl.sort(function(a, b) { return a.distance - b.distance;});


//nb_reponses = 10;

//on recup plus grande distance
//var maxdist=tabreq[nb_reponses-1].distance;
//re_initGM();

chaine_mode_transport= 
"<IMG id=\"TRANSIT\" class=\"travmode\" SRC=\"traintra.gif\"  width=\"13%\">"
+ "<IMG id=\"WALKING\" class=\"travmode\" SRC=\"pietontra.gif\" width=\"13%\">"
+ "<IMG id=\"DRIVING\" class=\"travmode\" SRC=\"voituretra.gif\" width=\"13%\">"
+ "<IMG id=\"BICYCLING\" class=\"travmode\" SRC=\"velotra.gif\" width=\"13%\">";



//var chaine_input= "<input id=\"train\" input=\"\" src=\"traintra.jpg\"  width=\"7%\" onclick=\"getvehicule(1);getmonadresse()\" type=\"image\" /><input id=\"walk\" input=\"\" src=\"Marche.jpg\" width=\"7%\" onclick=\"getvehicule(3);getmonadresse()\" type=\"image\" />";
//+ "<a id=\"velo\" class=\"travmode\" width=\"12%\" type=\"image\" /><IMG SRC=\"velotra.gif\"></a>";
//+ "<div id=\"velo\" class=\"travmode\"><IMG SRC=\"velotra.gif\"></div>";


//Pagination
//calcul du nombre de pages (10 result par page)
nb_pages=Math.ceil(tabreq_ssdbl.length/10);

//alert("n pages:" + nb_pages)
num_page=1;
//on ajoute le form de la nouvelle recherche
//$("#saisie").remove();
//$("#saisie_nouvelle").remove();
//$("#saisie_nouvelle").append("Nouvelle recherche <input id=\"monadresse_new\" size=\"65\" maxlength=\"255\" style=\"font-size:70%;\" type=\"text\"/><input type=\"button\" style=\"font-size:70%;\" value=\"Chercher!\" onclick=\"getmonadresse();\">");


  
  //document.getElementById("contenuP").style.display="none";
  //document.getElementById("saisie_nouvelle").style.display="none";
  






Affiche_page();


			var options = {
   
   				componentRestrictions: {country: 'fr'}
			};
			var input = document.getElementById('monadresse_new');

			autocomplete = new google.maps.places.Autocomplete(input, options);

			google.maps.event.addListener(autocomplete, 'place_changed', function() {
			$('input').blur();

			getmonadresse(document.getElementById('monadresse_new').value);
  			  });
  			  
  			  $('input').on('submit', function(event){
   			 event.preventDefault();
			});
	
}



function Affiche_page(){
direction.setMap(null);
//Efface_marker();

google.maps.event.trigger(map, "resize");
document.getElementById("contenuP").style.display="inline-block";
document.getElementById("saisie").style.display="none";
document.getElementById("saisie_nouvelle").style.display="block";


//$("#saisie_nouvelle").child("input").remove;


lc_div = document.getElementById("contenu_gauche");
lc_div.innerHTML = "";

lt_div = document.getElementById("Panel");
lt_div.innerHTML = "";

ls_div = document.getElementById("saisie");
lc_div.innerHTML = "";

//on ajoute le form de la nouvelle recherche
//$("#saisie_nouvelle").append("<input class=\"inputarea\" id=\"monadresse_new\" name=\"monadresse\" size=\"65\" maxlength=\"255\" style=\"font-size:70%;\" type=\"text\"/><button type=\"button\" name=\"\" class=\"css3button\" style=\"font-size:70%;\" onclick=\"getmonadresse();\">Chercher!</button>");



i_deb = num_page * 10 -10;


//on compare 

if (num_page == nb_pages){
i_fin = tabreq_ssdbl.length;
}
else{i_fin = i_deb +10;}




//alert("next page");
$("#contenu_gauche").ready(function() {
   for(var i=i_deb; i < i_fin; i++) {
    	var lieu= "#lieu" + i;
		var suite = "#suite" +i;

	var chainegenre = "";
	if (tabreq_ssdbl[i].genre !="")
	{var chainegenre= 	 "<span style=\"font-size:80%;line-height:2em;\">" + tabreq_ssdbl[i].genre + "</span>" + "<br>" ;}
	
	var chainetel="";
	if (tabreq_ssdbl[i].phone !="")
	{var chainetel= 	 "<IMG width=\"7%\" SRC=\"tel2.gif\">" + "<span style=\"font-size:80%;line-height:3em;\">" + ": " +  tabreq_ssdbl[i].phone + "</span>" + "<br>";}
     //alert(tabreq[i].lien);
     $("#contenu_gauche").append("<div class=elem_lieu><div class=elem_lieu_gauche><div id=\"lieu" + i + "\" class=\"lieu\">" + "<span style=\"font-weight:bold;\">" + tabreq_ssdbl[i].nom + "</span>" + "<span style=\"font-size:70%;color:#777777;font-style:oblique;\">" + " - " + tabreq_ssdbl[i].distance/1000 + " km" + "</span>" + "<span style=\"font-size:80%;\" align=\"right\">" + " " + tabreq_ssdbl[i].budget + "</span>"+"<br>" 
		+ "<span><a style=\"font-size:90%;color:#E8AF07;font-style:font-weight:bold;\" target=\"_blank\" href=\"" + tabreq_ssdbl[i].lienfood + "\">" + tabreq_ssdbl[i].awardfood + "</a><span> </span>" 
		+ "<span><a style=\"font-size:90%;color:#E85507;font-style:font-weight:bold;\" target=\"_blank\" href=\"" + tabreq_ssdbl[i].lienmich + "\">" + tabreq_ssdbl[i].awardmich + "</a><span> </span>"
		+ "<span><a style=\"font-size:90%;color:#E89107;font-style:font-weight:bold;\" target=\"_blank\" href=\"http://" + tabreq_ssdbl[i].liengem + "\">" + tabreq_ssdbl[i].awardgem   + "</a><span> </span>" 
		+ "<span><a style=\"font-size:90%;color:#E86307;font-style:font-weight:bold;\" target=\"_blank\" href=\"http://" + tabreq_ssdbl[i].lienomn + "\">" + tabreq_ssdbl[i].awardomn   + "</a></span>" + "<br>"
		+ "</div><div id=\"suite" + i + "\" class=\"suite\" style=\"display: none; \">" 
		+ chainegenre
		+ "<span style=\"font-size:80%;\">" + tabreq_ssdbl[i].adresse + "</span>" + "<br>"
		+ chainetel 
		+ "<div style=\"text-align: center;\">" + chaine_mode_transport + "</div>" 
		+"</div></div></div>");

	//affichage carte
		MarkLatLng(tabreq_ssdbl[i]);


   }


   
});

 resize_div();
//var coucou = "coucouc";
	//	var h = $("#contenu_gauche").height();
	//	$("#contenu_Plan").height(h);

//$("IMG").click(alert("zouzou"));
// on modifie la hauteuir de plan en fonction de la hauteur de contenu_gauche

		

		
	p_suite_old = $(this).children(".elem_lieu_gauche").children(".suite");
	p_suite_old_id=$(this).children(".elem_lieu_gauche").children(".suite").attr('id');
	$(".elem_lieu").bind('click',function(){
		//alert("zouzou");
		p_suite = $(this).children(".elem_lieu_gauche").children(".suite");
		p_suite_id=$(this).children(".elem_lieu_gauche").children(".suite").attr('id');
				lieu_cur=p_suite_id.substr(5);	
		//var lieu_cur = $(this).parent(".elem_lieu").attr('id');// on recup l'id du p contenant l'icone ex: suite1
		//lieu_cur = lieu_cur.substr(5);
	
		//lieu_cur=tabreq_ssdbl[lieu_cur].adresse;
			
					  if (prev_infowindow!="0")
 			 {prev_infowindow.close();}
 		 infowindow = new google.maps.InfoWindow();
  
  			infowindow.setContent('<div><strong>' + tabreq_ssdbl[lieu_cur].nom + '</strong><br>' + tabreq_ssdbl[lieu_cur].adresse);
 		 //alert("infos");

			infowindow.open(map, markers[lieu_cur]);
			prev_infowindow = infowindow;
		if(p_suite_id != p_suite_old_id) {
			$(p_suite_old).slideUp(400);
			$(p_suite).slideDown(400,function() {
		//Redimensionne();
		$("#Plan").width("100%");
		google.maps.event.trigger(map, "resize");
		lt_div = document.getElementById("Panel");
		lt_div.innerHTML = "";

		
		fitMap(i_deb,i_fin);
  		});
  		

			
			
			
			}
		p_suite_old = p_suite;
		p_suite_old_id=p_suite_id;
		//alert(aaaa);




	

		})
	;

if (num_page != 1)
{$("#contenu_gauche").append("<span><button type=\"button\" class=\"css3button\" style=\"font-size:70%;\" onclick=\"clearMarkers();num_page--;Affiche_page(num_page);\">Page précédente</button><\span>");}


if (num_page != nb_pages)
{$("#contenu_gauche").append("<span><button type=\"button\" class=\"css3button\" style=\"font-size:70%;\" onclick=\"clearMarkers();num_page++;Affiche_page(num_page);\">Page suivante</button><\span>");}



Redimensionne();
	$("#Plan").width("100%");
google.maps.event.trigger(map, "resize");
fitMap(i_deb,i_fin);
				


	$(".travmode").bind('click',function(){
	
	//alert("showroute");

	//map.setCenter(new google.maps.LatLng(Monadresse.lat,Monadresse.lng));
	var mode_deplacement = $(this).attr("id");
	
	var zarrivee = $(this).parent("div").parent("div").attr('id');// on recup l'id du p contenant l'icone ex: suite1
	zarrivee = zarrivee.substr(5);
	//alert(zarrivee);
	zarrivee = tabreq_ssdbl[zarrivee].adresse;
	//var zarrivee = tabreq[zarrivee].adresse + " " + tabreq[zarrivee].cp;
    var depart = Monadresse_O.adresse;
	
	//alert("fffffff"+ mode_deplacement + "zarrivee" + zarrivee + "kjlj" + depart);
	
	ShowRoute(depart, zarrivee, mode_deplacement);
		
	})
	;


}

function Redimensionne() 
{
    	var h = $("#contenu_gauche").height();
		//alert(h);

		//var h_saisie = $("#saisie_nouvelle").height();
		//alert(h);

		
		//$("#Plan").height(h-h_saisie);
		$("#Plan").height(h);
		
}

function fitMap(deb,fin) 
{
//alert("fitbounds");
    var bounds = new google.maps.LatLngBounds();
   
      /* Déclaration et remplissage du tableau qui contiendra nos points, objets LatLng. */
   var myPoints = [];
   j=0;
   /* Déclaration des options de la map */ 
   var options = {
    /*zoom : 7,
    center: latlng, */
    //  ici, ces 2 valeurs ne sont plus utiles car calculées automatiquement
    mapTypeId: google.maps.MapTypeId.ROADMAP
   }

   /* Ici, nous déclarons l'élément html ayant pour id "map" comme conteneur de la map *
	
   /* Boucle sur les points afin d'ajouter les markers à la map
   et aussi d'étendre ses limites (bounds) grâce à la méthode extend */ 
   for(var i=deb; i < fin; i++){
   //alert("i:" + i);
   	myPoints.push( new google.maps.LatLng(tabreq_ssdbl[i].lat,tabreq_ssdbl[i].lng));
   	//alert("2");
    bounds.extend(myPoints[j]);
    j++;
    //alert("2");
   	//MarkLatLng(tabreq_ssdbl[i]);

   }

   /* Ici, on ajuste le zoom de la map en fonction des limites  */ 
   map.fitBounds(bounds);
   map.setCenter(new google.maps.LatLng(Monadresse.lat,Monadresse.lng));
}


function setAllMap(map) {
  for (var i = 0; i < markers.length; i++) {
    markers[i].setMap(map);
  }
}

// Removes the markers from the map, but keeps them in the array.
function clearMarkers() {
  setAllMap(null);
}



function ShowRoute(depart, arrivee, mode_deplacement){
//map = new google.maps.Map(document.getElementById("Plan"), mapOptions);
	


//alert("showroute" + 
direction.setMap(null);

  //direction.suppressMarkers = true;
  //direction.setDirections({routes: []});
  //direction.set('directions', null);
    origin      = depart; // Le point départ
    destination = arrivee; // Le point d'arrivé
    //alert("dep" + origin + "arr" + destination);
    if(origin && destination){
        var request = {
            origin      : origin,
            destination : destination,
            travelMode  : google.maps.TravelMode[mode_deplacement],// + mode_deplacement
        }
        
        
        var directionsService = new google.maps.DirectionsService(); // Service de calcul d'itinéraire
        directionsService.route(request, function(response, status){ // Envoie de la requête pour calculer le parcours
            if(status == google.maps.DirectionsStatus.OK){
            
            	$("#Plan").width("64%");
	google.maps.event.trigger(map, "resize");
                //direction.setDirections(response);
                direction.setDirections(response);
                //direction.set('directions', null);
                direction.setMap(map); // Trace l'itinéraire sur la carte et les différentes étapes du parcours
            	direction.setPanel(document.getElementById("Panel"));
            
            }
            else {alert("Itinéraire indiponible.");}
        });
    } 
    //http://code.google.com/intl/fr-FR/apis/maps/documentation/javascript/reference.html#DirectionsRequest
		
}

function affiche_lieu(lieu)
{
//alert("aff=iche liste verif moi" + Monadresse.nom);
//lc_div = document.getElementById("contenu_gauche");
//if (lc_div.innerHTML == ""){
//var D_itineraire = Calcul_distance(Monadresse,lieu);
lc_div.innerHTML += "<UL>" + lieu.nom + "<li>" + lieu.distance/1000 + "km" + "</li>" + "</UL>";
MarkLatLng(lieu);
// créer un lien vers une page qui affiche
}


function addThisMarker(point,m){
    var marker = new google.maps.Marker({position: point});
    return marker;
   }


function MarkLatLng(lieu) {
//document.write(nom);
var myLatlng = new google.maps.LatLng(lieu.lat,lieu.lng);
//var nom = addslashes(lieu.nom);
var marker = new google.maps.Marker({
							position: myLatlng,
							map: map,
							icon: "restaurant.png",
							title: lieu.nom
							}
							);
markers.push(marker);


  google.maps.event.addListener(marker, 'click', function() {
  if (prev_infowindow!="0")
  {prev_infowindow.close();}
  infowindow = new google.maps.InfoWindow();
  
  infowindow.setContent('<div><strong>' + lieu.nom + '</strong><br>' + lieu.adresse);
  //alert("infos");
	infowindow.open(map, marker);
	prev_infowindow = infowindow;

 
  });
}




function Initialise_Affichage_Tab()
{

	lc_div = document.getElementById("contenu_gauche");
	n_distance=nbre_lieux;
	//alert("nb lieux" +  nbre_lieux);
	var n=0;
	//calcul non google bloc à commenter si utilisation google
	while (n<=n_distance-1){
		//alert("n" + n);
		Calcul_distance(Monadresse_O,tabreq[n]);
		n=n+1;
		}
	trie_affiche_tableau("caca");
	//calcul google recursif
	//Calcul_distance_Google(Monadresse_O,tabreq[0]);
}

function Calcul_distance(depart,arrivee){
//calcule la distance et la met dans l'objet arrivée
//distance = Math.round(Math.sqrt((arrivee.lat - depart.lat)*(arrivee.lat - depart.lat)+(arrivee.lng - depart.lng)*(arrivee.lng - depart.lng))*1000);
distance = calDistance(depart.lat,depart.lng,arrivee.lat,arrivee.lng);
//alert(distance);
arrivee.ajout_distance(distance);
}



function convertRad(input){
        return (Math.PI * input)/180;
}
 
function calDistance(lat_a_degre, lon_a_degre, lat_b_degre, lon_b_degre){
  //alert("dist");   
        R = 6378000; //Rayon de la terre en mètre
 
    lat_a = convertRad(lat_a_degre);
    lon_a = convertRad(lon_a_degre);
    lat_b = convertRad(lat_b_degre);
    lon_b = convertRad(lon_b_degre);
     
    d = R * (Math.PI/2 - Math.asin( Math.sin(lat_b) * Math.sin(lat_a) + Math.cos(lon_b - lon_a) * Math.cos(lat_b) * Math.cos(lat_a)));
	d= Math.round(d);
    return d;
}


function VerifListeAction() {
	//modifie l'element selectionné dans la liste actions
	//document.write('toto');
	var ObjListe = document.getElementById('ListeAction');
	var SelIndex = ObjListe.selectedIndex;
	var SelValue = ObjListe.options[ObjListe.selectedIndex].value;
	//var SelText = ObjListe.options[ObjListe.selectedIndex].text;
	action = SelValue;
	aParams = {
		"type": "Action",
		"action": action,
		"distance": Distance
		};
	//document.write(action);
} //VerifListeDistance()


function VerifListeDistance() {
	//modifie l'element selectionné dans la liste actions
	//document.write('toto');
	var ObjListe = document.getElementById('ListeDistance');
	var SelIndex = ObjListe.selectedIndex;
	var SelValue = ObjListe.options[ObjListe.selectedIndex].value;
	var SelText = ObjListe.options[ObjListe.selectedIndex].text;
	Distance = SelValue;
	aParams = {
	"type": "Action",
	"action": action,
	"distance": Distance
	};
	//document.write(Distance);
}

function recupGPS()
{
alert('recupGPS');
zUrl = "RecupGPS.php";
//FScript.src = zUrl;
var DSLScript = document.createElement("script");
DSLScript.src = zUrl;
DSLScript.type = "text/javascript";
document.body.appendChild(DSLScript);
document.body.removeChild(DSLScript);
}

function ecrisGPS()
{
	var t=0;
	alert('ecrisGPS');
	zUrl = "PutGPS.php";
	//alert(m);
	//alert('crotte');
	//alert(tabreq[10]);
	while (tabreq[t].nom != "")
	{
	alert(tabreq[t].nom);
	//alert(tabreq[t].id);
	reqParams = {
	"nom": tabreq[t].nom,
	"lat": tabreq[t].lat,
	"lng": tabreq[t].lng,
	"id": tabreq[t].idbase
	};
	sendRq(zUrl,reqParams);
	//alert(tabreq[t].nom);
	t=t+1;
	}
	//alert('fin de boucle');
	//var DSLScript = document.createElement("script");
	//DSLScript.src = zUrl;
	//DSLScript.type = "text/javascript";
	//document.body.appendChild(DSLScript);
	//document.body.removeChild(DSLScript);
} 

function sendRq(sUrl, oParams) {
//alert("surl" + sUrl);
//alert(sUrl);
for (sName in oParams) {
	if (sUrl.indexOf("?") != -1) {
	sUrl += "&";
	} 
	else {
	sUrl += "?";
	}
	sUrl += encodeURIComponent(sName) + "=" + encodeURIComponent(oParams[sName]);
}
//sUrl = sUrl + "&" + dist;
//test l'url
//alert("construction url OK:" + sUrl);
//alert(sUrl);
$.ajax( {
		type: "GET",
		url: sUrl,
		success: function(data) {
		//response = data;
		//alert(data);
		tabreq = [];
		nbre_lieux = 0;
		//n_distance = //var lieu = xml.getElementsByTagName("lieu");
		//nom=lieu.item(0).firstChild.data;
		//alert("nomreq" + nom);
		var parser=new DOMParser();
		var docXML=parser.parseFromString(data.trim(),'text/xml');
		$(docXML).find('lieu').each( function()
						{
						//alert("ok dans parser");
						//nbre_lieux++;
						var id = $(this).find('id').text();
						var adresse = $(this).find('adresse').text();
						var nom = $(this).find('nom').text();
						var cp = $(this).find('cp').text();
						var lat = $(this).find('lat').text();
						var lng = $(this).find('lng').text();
						var phone = $(this).find('phone').text();
						var budget = $(this).find('budget').text();
						var action = $(this).find('action').text();
						var genre = $(this).find('genre').text();
						var award = $(this).find('award').text();
						var lien = $(this).find('lien').text();
						var numresto = $(this).find('numresto').text();
						var guide = $(this).find('guide').text();
						//alert("genre");
						tabreq[nbre_lieux]= new MonLieu(nom,adresse,id,cp,lat,lng,action,budget,phone,genre,null,award,lien,numresto,guide);
						//alert("result" + id + nom + adresse);
						nbre_lieux++;
						});
		//alert(nbre_lieux);
		Initialise_Affichage_Tab(); }
		});
}

function initialisation ()  {
tabreq = [];
tabreq_ssdbl = [];
tabreq_numresto = [];
markers = [];

}

function getmonadresse(address) {
initialisation();
//alert(address);
//address = document.forms["form1"].elements["monadresse"].value;
//Monadresse = document.forms["form1"].elements["monadresse"].value;
//address = document.getElementById('monadresse').value;
//Monadresse = document.getElementById('monadresse').value;

geocoder = new google.maps.Geocoder(); geocoder.geocode( { 'address': address,'region':'fr'}, function(results, status) 
	{
	if (status == google.maps.GeocoderStatus.OK) {
			var marker = new google.maps.Marker(
			{
			map: map,
			//center: position: results[0].geometry.location,
			title: "Ma place"
			}
			);
			Lat=results[0].geometry.location.lat();
			Lng=results[0].geometry.location.lng();
			//alert("codead" + Lat + Lng);
			var myLatlng = new google.maps.LatLng(Lat,Lng);
			//MarkLatLng(Lat,Lng,nom);
			//return myLatlng;
			var mapOptions = {
			mapTypeControl: true,
    		mapTypeControlOptions: {
        		style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
        		position: google.maps.ControlPosition.TOP_RIGHT
    		},
    		zoomControl: true,
    		zoomControlOptions: {
        		style: google.maps.ZoomControlStyle.SMALL,
        		position: google.maps.ControlPosition.TOP_RIGHT
    		},
    		panControl: false,
			zoom: 14,
			center: myLatlng,
			mapTypeId: google.maps.MapTypeId.ROADMAP
			}
			map = new google.maps.Map(document.getElementById("Plan"), mapOptions);
			var depart = new google.maps.Marker
			({
			map: map,
			icon: 'flagman.png',
			title: "Je suis ici",
			position: new google.maps.LatLng(Lat, Lng),
			});
			//alert(Lat);
			aParams= {
			"type": "Action",
			"action": action,
			"distance": Distance,
			"monadresse_lat": Lat,
			"monadresse_lng": Lng
			};
			//alert("changé" + Lat); //sendRq(sUrl,aParams);
			Monadresse= {
			nom: "Moi",
			adresse: address,
			lat: Lat,
			lng: Lng
			};
			
			//crotte = results;
			//alert(results[0].address_components[0].street_address);
   

			//MonLieu(nom,adresse,idbase,cp,lat,lng,action,budget,phone,distance)
			Monadresse_O = new MonLieu(Monadresse.nom,Monadresse.adresse,null,null,Monadresse.lat,Monadresse.lng,null, null,null,null,null);
			//alert("obejt monadresse" + Monadresse_O.lat);
			sendRq(sUrl,aParams);
			} 
		else { // adresse non geolocalisable
		alert("Désolé, nous ne pouvons pas localiser cette adresse!");
		}
	});
}

function getvehicule(vehicule) {
//1 auto
//2 velo
//3 walk
alert("monadresse" + Monadresse);
	switch(vehicule)
	{
	case "voiture":
	//alert("travelmode:"+vehicule);
	travelmode = google.maps.DirectionsTravelMode.DRIVING
	break;
	case "velo":
	travelmode = google.maps.DirectionsTravelMode.BICYCLING
	break;
	case "pieton":
	travelmode = google.maps.DirectionsTravelMode.WALKING
	break; 
	case "train":
	travelmode = google.maps.DirectionsTravelMode.TRANSIT
	break; }
}


function resize_div(){
	//alert("resize");

	Redimensionne();

	
	fitMap(i_deb,i_fin);
	
}

	
	window.onresize=resize_div;

 		 google.maps.event.addDomListener(window, 'load', initialize_map);
</script>


    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Noto+Serif">
    <style>
      body {
        font-family: 'Noto Serif', serif;
      }
    </style>



</head>


<body>




<div id="haut">
	<div id="haut_gauche">
		<div id="titre">foodisTown</div>
		<div id="soustitre">Toute la gastronomie à portée de main!</div>
	</div>
	<div id="haut_droite">
		<div id="image_couvert">
			<img id="icon" src="panneaufourche.jpg"/>
		</div>
		<div id="fb-root">

        <iframe src="http://www.facebook.com/plugins/like.php?href=http://www.foodistown.com&layout=box_count&show_faces=true&width=65&action=like&font=arial&colorscheme=light&height=65"
    scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:65px; height:65px; margin-top:3px;" allowTransparency="true"></iframe>
		</div>
	</div>
	
</div>

		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
 		<script src="jquery.fittext.js"></script>
		<script type="text/javascript">
		

		
		$("#titre").fitText(1, { minFontSize: '16px', maxFontSize: '80px' });
		$("#soustitre").fitText(1.7, { minFontSize: '8px', maxFontSize: '24px' });
		</script>
		<div id="saisie">

			
			Trouvez les meilleures tables autour de vous! 
			<br>

			
			
			
			<input id="monadresse_f" type="search" value="" size="65" maxlength="255" style="font-size:70%">
      		<input type="button" style="font-size:70%" value="Chercher!" onclick="getmonadresse(document.getElementById('monadresse_f').value)">
			
			<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?libraries=places&amp;sensor=false"></script>
			<script type="text/javascript">
			//document.getElementById("saisie_nouvelle").style.display="none";
			var options = {
   
   				componentRestrictions: {country: 'fr'}
			};
			var inpute = document.getElementById('monadresse_f');

			autocomplete = new google.maps.places.Autocomplete(inpute, options);

			google.maps.event.addListener(autocomplete, 'place_changed', function() {
			$('inpute').blur();
			
			getmonadresse(document.getElementById('monadresse_f').value);
  			  });
  			  
  			  $('inpute').on('submit', function(event){
   			 event.preventDefault();
			});
			//sUrl = 'testdata.php';
			sUrl = 'Data_ajax_xml.php';
			//sUrl = 'test.php';
			//document.write(sUrl);
			//
			//document.write(action);
			//document.write(Distance);
			aParams = {
			"type": "Action",
			"action": action,
			"distance": Distance
			};
			//Monadresse = document.forms["form1"].elements["monadresse"].value;
			//alert("monadresse" + Monadresse);

			</script>
	
			
			
			


			
			<script src="jquery.fittext.js"></script>
			<script type="text/javascript">
		
		
			$("#saisie").fitText(3.5, { minFontSize: '8px', maxFontSize: '15px' });
			</script>
			</div>
	


<div id="contenuP">
	
	
	<div id="contenu_gauche">
	
	

		<script src="jquery.fittext.js"></script>
		<script type="text/javascript">
		

		
		$("#contenu_gauche").fitText(2.0, { minFontSize: '7px', maxFontSize: '14px' });
		</script>
	
	
	
	</div>
	<div id="contenu_droite">
	

		
		<div id="saisie_nouvelle">
				      	<input id="monadresse_new" type="search" value="" value="" size="65" maxlength="255" style="font-size:70%">
      					<input type="button" style="font-size:70%" value="Chercher!" onclick="getmonadresse(document.getElementById('monadresse_new').value)">
      	
	
			<script type="text/javascript">
			document.getElementById("saisie_nouvelle").style.display="none";

			//sUrl = 'testdata.php';
			sUrl = 'Data_ajax_xml.php';
			//sUrl = 'test.php';
			//document.write(sUrl);
			//
			//document.write(action);
			//document.write(Distance);
			aParams = {
			"type": "Action",
			"action": action,
			"distance": Distance
			};
			//Monadresse = document.forms["form1"].elements["monadresse"].value;
			//alert("monadresse" + Monadresse);

			</script>

			
			<script src="jquery.fittext.js"></script>
			<script type="text/javascript">
		

		
			$("#saisie_nouvelle").fitText(2.0, { minFontSize: '8px', maxFontSize: '15px' });
			</script>
			</div>
		<div id="Plan">
			
		</div>

		
		<div id="Panel">
				<script src="jquery.fittext.js"></script>
						<script type="text/javascript">
				$("#Panel").fitText(2.0, { minFontSize: '6px', maxFontSize: '18px' });
				</script>
		</div>
	
	</div>
</div>
<div id="piedpage">


  <script type="text/javascript">
  
  document.getElementById("contenuP").style.display="none";
  //document.getElementById("saisie_nouvelle").style.display="none";





 
 
 </script>			
<footer>
	<p>Copyright FoodisTown - Tous droits réservés<br>

	<a href="mailto:foodistown@gmail.com">Nous contacter !</a></p>
</footer>

		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
<script src="jquery.fittext.js"></script>
		<script type="text/javascript">
		
		$("footer").fitText(3.5, { minFontSize: '6px', maxFontSize: '16px' });
		</script>
</div>

</body>
</html> 
